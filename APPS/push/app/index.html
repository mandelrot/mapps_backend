<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.4.5/spectre.min.css">
  <title>Utils example</title>
</head>
<body style="padding: 40px;">

  <h2>Broadcasting push notifications</h2>
  <p>There's a specific socket channel created to backend-push and frontend-listen messages. In this app we will see an example of how it works.</p>

  <hr style="margin: 50px 0;">

  <p>When you press the button below, this frontend app will send a message to your backend: there's a function called "triggerPush" in your internal.js module that will invoked. Nothing new so far.</p>

  <p>Here is where things get interesting: this backend function will then send a socket event that will be listened by the backend, and the backend (after some validations and processing) will broadcast it to everyone connected. This page (and potentianlly any other else)will listen to this broadcasted event, and once received you will see the message below.</p>

  <p>Click the button to lauch it:</p>

  <button onclick="triggerBroadcast()">Let's go</button>

  <div id="incoming-container" style="margin-top: 50px; padding: 15px; border: 1px solid black;" hidden>
    <p>Backend broadcast received:</p>
    <h4 id="incoming" style="margin-left: 15px;"></h4>

    <p>In this case the "sender" app tells everyone to refresh its backend info. The frontend app will be supposed to have some resources to react to this notification.</p>
    <p>By security reasons, there are only two possible actions: "reload" and "logout" (if "logout" the event object would have a third "user" field, to know who should be logged out)</p>
  </div>

  <p style="margin-top: 50px;">See the code to see how it's done.</p>





  <script src="/push/socket.io.min.js"></script>
  <script src="/database/backend-static/serverport.js"></script> <!-- file self-generated by the backend -->
  <script>
    const socket = io(`http://127.0.0.1:${serverPort}`); // Coming from /backend-static/serverport.js


    function triggerBroadcast() {
      const message = {
        app: 'push',
        to: 'push', // This will be redirected to internal.js since source and target are the same
        action: 'triggerPush',
        data: {
          params: []
        }
      }
      socket.emit('msgFromApp', message, (response) => {
        if (response && response.msgError) { return alert(response.msgError) }
      });
    }

    socket.on('broadcast', (message) => {
      document.getElementById('incoming-container').removeAttribute('hidden');
      document.getElementById('incoming').innerText = message;
    });


  </script>



</body>
</html>